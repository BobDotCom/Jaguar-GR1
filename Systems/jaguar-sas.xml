<?xml version="1.0"?>

<!-- Jaguar SAS System -->
<!-- Richard Harrison (C) 2020; rewritten completely.-->

<system name="SAS">
	
	<property value="1">sas/pitch-l</property>
	<property value="1">sas/pitch-r</property>
	<property value="57.142">sas/pitch-damping-1-c1</property>
	
    <channel name="Pitch Trim">
		
		<switch name="sas/pitch-autotrim-active">
		  <default value="0"/>
		  <test logic="AND" value="1">
			position/wow eq 0
			gear/gear-pos-norm lt 1
			fcs/ap-pitch-cmd-norm le 0.05
			fcs/ap-pitch-cmd-norm ge -0.05
			autoflight/input/pitch-switch ne 1
		  </test>
		</switch>
		
		<fcs_function name="sas/pitch-autotrim-offset">
			<function>
				<product>
					<property>sas/pitch-autotrim-active</property>
					<table>
						<!-- guts of the auto pitch trim; this is a preset table
							 tuned to adjust pitch trim based on Qaero.
							 In the aircraft this is done by adjusting the datum 
							 of the AJAX unit; however this will serve the same purpose.
						 -->
						<independentVar lookup="column">velocities/vc-kts</independentVar>
						<independentVar lookup="row">velocities/q-rad_sec</independentVar>
						<tableData>
							                	150     	700
								-0.1000 	-0.03100	-0.03150
								-0.0100 	-0.00150	-0.00225
								 0.0000 	 0.00000	 0.00000
								 0.0100 	 0.00150	 0.00225
								 0.1000 	 0.03100	 0.03150
							</tableData>
					</table>
				</product>
			</function>
		</fcs_function>
		
		<fcs_function name="sas/autotrim-output">
		  <function>
			<sum>
			  <property>/controls/flight/elevator-trim</property>
			  <value>0</value>
			  <!-- <property>sas/pitch-autotrim-offset</property> -->
			</sum>
		  </function>
		  <clipto>
			<min>-0.3</min>
			<max>0.3</max>
		  </clipto>
		  <!-- <output>/controls/flight/elevator-trim</output> -->
		</fcs_function>
	  
	  </channel>

	  <channel name="Pitch">
		<switch name="sas/pitch-switch">
			<default value="0"/>
			<test value="0">
				position/wow eq 1
			</test>
			<test logic="OR" value="1">
				sas/pitch-l eq 1
				sas/pitch-r eq 1
			</test>
		</switch>

 		<washout_filter name="sas/pitch-damping-1">
			<input>velocities/q-rad_sec</input>
			<c1>0.475</c1>
		</washout_filter>
		
		<scheduled_gain name="sas/pitch-damping-2">
			<input>sas/pitch-damping-1</input>
			<table>
				<independentVar>velocities/vc-kts</independentVar>
				<tableData>
					150  1.421
					950  0.8872
				</tableData>
			</table>
			<clipto>
				<min>-0.3</min>
				<max>0.3</max>
			</clipto>
		</scheduled_gain>

		<pure_gain name="sas/pitch-output">
			<input>sas/pitch-damping-2</input>
			<gain>sas/pitch-switch</gain>
			<clipto>
				<min>-0.6</min>
				<max>0.6</max>
			</clipto>
		  </pure_gain>
	
	</channel>
	
	<property value="1">sas/yaw-l</property>
	<property value="1">sas/yaw-r</property>

	<property value="3.12">sas/yaw-v1-c1</property>
	<property value="3.333">sas/yaw-v2-c1</property>
	<property value="0.4">sas/yaw-v3-c1</property>
	<property value="0.7">sas/yaw-v5-c</property>
	<property value="0.955">sas/yaw-v6-c</property>
	<property value="100.0">sas/yaw-v7-c1</property>

	<property value="0">sas/yaw-active</property>

	<channel name="Yaw">
		<!-- switch to determine if yaw damper active -->
		<switch name="sas/yaw-switch">
			<default value="0" />
			<test value="0">
				position/wow eq 1
			</test>
			<test logic="OR" value="1">
				sas/yaw-r ne 0
				sas/yaw-l ne 0
			</test>
		</switch>

		<fcs_function name="sas/yaw-v1">
			<function>
				<product>
					<property>velocities/r-rad_sec</property>
					<property>sas/yaw-v1-c1</property>
					<table>
						<independentVar lookup="row">velocities/vc-kts</independentVar>
						<tableData>
							100 1.0
							200 0.6
							300 0.3
							400 0.31
							600 0.1
						</tableData>
					</table>
				</product>
			</function>
		</fcs_function>

		<lag_filter name="sas/yaw-v2">
			<input>sas/yaw-v1</input>
			<c1>sas/yaw-v2-c1</c1>
		</lag_filter>

		<washout_filter name="sas/yaw-v3">
			<input>sas/yaw-v2</input>
			<c1>sas/yaw-v3-c1</c1>
		</washout_filter>

		<!-- Feedback loop from output -->
		<lag_filter name="sas/yaw-v7-value">
			<input>sas/yaw-v6</input>
			<c1>sas/yaw-v7-c1</c1>
		</lag_filter>

		<fcs_function name="sas/yaw-v6">
			<function>
				<product>
					<property>sas/yaw-v5</property>
					<property>sas/yaw-v6-c</property>
				</product>
			</function>
		</fcs_function>

		<!-- uses yaw-v-active as initial condition -->
		<fcs_function name="sas/yaw-v7">
			<function>
				<ifthen>
					<or>
						<eq>
							<property>sas/yaw-v-active</property>
							<v>0</v>
						</eq>
						<lt>
							<property>sim-time-sec</property>
							<v>0.5</v>
						</lt>
					</or>
					<property>sas/yaw-v3</property>
					<property>sas/yaw-v7-value</property>
				</ifthen>
			</function>
		</fcs_function>
		<!-- End feedback from output -->

		<fcs_function name="sas/yaw-v5">
			<function>
				<product>
					<difference>
						<property>sas/yaw-v3</property>
						<property>sas/yaw-v7</property>
					</difference>
					<property>sas/yaw-v5-c</property>
				</product>
			</function>
			<clipto>
				<min>-4</min>
				<max>4</max>
			</clipto>
		</fcs_function>

		<!-- active flag - needed for initial reset -->
		<fcs_function name="sas/yaw-v-active">
			<function>
				<ifthen>
					<eq>
						<property>sas/yaw-switch</property>
						<v>0</v>
					</eq>
					<value>0</value>
					<value>1</value>
				</ifthen>
			</function>
			<output>sas/yaw-active</output>
		</fcs_function>

		<fcs_function name="sas/yaw-output">
			<function>
				<ifthen>
					<eq>
						<property>sas/yaw-switch</property>
						<v>0</v>
					</eq>
					<value>0</value>
					<property>-sas/yaw-v7</property>
					>
				</ifthen>
			</function>
			<clipto>
				<min>-4</min>
				<max>4</max>
			</clipto>
		</fcs_function>

	</channel>

	<!-- 
		Roll stability is a roll damper.
		Maximum spoiler is 45deg;  gives pitch up of 1deg nose up
	-->
	<channel name="autoslats">
		<switch name="sas/autoslat-active">
			<default value="0" />
			<test logic="AND" value="1">
			aero/alpha-deg gt 4
			velocities/vc-kts lt 580
			/controls/flight/flaps eq 0
		</test>
		</switch>

		<fcs_function name="sas/autoslat-deg">
			<function>
				<product>
					<property>sas/autoslat-active</property>
					<table>
						<independentVar lookup="row">aero/alpha-deg</independentVar>
						<tableData>
					 4   0
					 7   0.391
				</tableData>
					</table>
				</product>
			</function>
		</fcs_function>

	</channel>
</system>
