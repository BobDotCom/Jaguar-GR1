<?xml version="1.0"?>

<!-- Jaguar SAS System -->
<!-- (c) 2018 Joshua Davidson (it0uchpods) -->
<!-- All guesses cause I can't find any data! -->

<system name="SAS">
	
	<property value="1">sas/pitch-l</property>
	<property value="1">sas/pitch-r</property>
	<property value="57.142">sas/pitch-damping-1-c1</property>
	
	<channel name="Pitch">
		<switch name="sas/pitch-switch">
			<default value="0"/>
			<test value="0">
				position/wow eq 1
			</test>
			<test logic="OR" value="1">
				sas/pitch-l eq 1
				sas/pitch-r eq 1
			</test>
		</switch>

 		<washout_filter name="sas/pitch-damping-1">
			<input>velocities/q-rad_sec</input>
			<c1>0.475</c1>
		</washout_filter>
		
		<scheduled_gain name="sas/pitch-damping-2">
			<input>sas/pitch-damping-1</input>
			<table>
				<independentVar>velocities/vc-kts</independentVar>
				<tableData>
					150  1.421
					950  0.8872
				</tableData>
			</table>
			<clipto>
				<min>-0.3</min>
				<max>0.3</max>
			</clipto>
		</scheduled_gain>

		<pure_gain name="sas/pitch-output">
			<!--input>fcs/aileron-cmd-norm</input-->
			<input>sas/pitch-damping-2</input>
			<gain>sas/pitch-switch</gain>
			<clipto>
				<min>-0.6</min>
				<max>0.6</max>
			</clipto>
		  </pure_gain>
	
	</channel>
	
	<channel name="Pitch Trim">
		
		<switch name="sas/autotrim-switch">
			<default value="0"/>
			<test logic="AND" value="0">
				velocities/q-rad_sec gt 0.0
				position/wow eq 0
				fcs/ap-pitch-cmd-norm le 0.05
				fcs/ap-pitch-cmd-norm ge -0.05
				autoflight/input/pitch-switch ne 1
			</test>
			<test logic="AND" value="0">
				velocities/q-rad_sec lt 0.0
				position/wow eq 0
				fcs/ap-pitch-cmd-norm le 0.05
				fcs/ap-pitch-cmd-norm ge -0.05
				autoflight/input/pitch-switch ne 1
			</test>
		</switch>
		
		<fcs_function name="sas/autotrim-offset">
			<function>
				<product>
					<sum>
						<ifthen>
							<eq>
								<property>sas/autotrim-switch</property>
								<value>1</value>
							</eq>
							<table>
								<independentVar lookup="row">velocities/q-rad_sec</independentVar>
								<tableData>
									0.00  0.0000
									0.01  0.0001
									0.10  0.0015
								</tableData>
							</table>
							<value>0.0</value>
						</ifthen>
						<ifthen>
							<eq>
								<property>sas/autotrim-switch</property>
								<value>2</value>
							</eq>
							<table>
								<independentVar lookup="row">velocities/q-rad_sec</independentVar>
								<tableData>
									-0.10 -0.0015
									-0.01 -0.0001
									-0.00 -0.0000
								</tableData>
							</table>
							<value>0.0</value>
						</ifthen>
					</sum>
					<table>
						<independentVar lookup="row">velocities/vc-kts</independentVar>
						<tableData>
							150  1.0
							950  0.1
						</tableData>
					</table>
				</product>
			</function>
		</fcs_function>
		
		<fcs_function name="sas/autotrim-output">
			<function>
				<sum>
					<property>/controls/flight/elevator-trim</property>
					<property>sas/autotrim-offset</property>
				</sum>
			</function>
			<clipto>
				<min>-0.3</min>
				<max>0.3</max>
			</clipto>
			<output>/controls/flight/elevator-trim</output>
		</fcs_function>
	
	</channel>
	
	<property value="1">sas/yaw-damper-cmd</property>
	<property value="1.352">sas/yaw-v1-c1</property>
	<property value="0.601">sas/yaw-v1-c2</property>
	<property value="3.333">sas/yaw-v2-c1</property>
	<property value="0.143">sas/yaw-v3-c1</property>
	<property value="1.502">sas/yaw-v5-c</property>
	<property value="0.955">sas/yaw-v6-c</property>
	<property value="100.0">sas/yaw-v7-c1</property>

	<property value="0">sas/yaw-active</property>

	<channel name="Yaw">
		<!-- switch to determine if yaw damper active -->
		<switch name="sas/yaw-switch">
			<default value="0" />
			<test value="0">
				position/wow eq 1
			</test>
			<test logic="OR" value="1">
				sas/yaw-damper-cmd ne 0
			</test>
		</switch>

		<!-- preset lookup of r -->
		<fcs_function name="sas/yaw-rate-predicted-rad_sec">
			<function>
				<table>
					<independentVar lookup="row">attitude/phi-deg</independentVar>
					<independentVar lookup="column">velocities/vc-kts</independentVar>
					<tableData>
								 200         300         400         500         600         700
					-90    -0.118243   -0.059850   -0.054086   -0.028030   -0.024050   -0.021370
					-70    -0.090518   -0.057120   -0.046700   -0.024690   -0.023860   -0.021940
					-35    -0.075220   -0.054476   -0.021474   -0.018000   -0.015763   -0.012543
					-20    -0.060116   -0.020270   -0.012572   -0.013590   -0.008988   -0.007700
					-10    -0.044000   -0.010830   -0.007897   -0.005505   -0.005166   -0.004334
					  0     0.000000    0.000000    0.000000    0.000000    0.000000    0.000000
					 10     0.044000    0.010830    0.007897    0.005505    0.005166    0.004334
					 20     0.060116    0.020270    0.012572    0.013590    0.008988    0.007700
					 35     0.075220    0.054476    0.021474    0.018000    0.015763    0.012543
					 70     0.090518    0.057120    0.046700    0.024690    0.023860    0.021940
					 90     0.118243    0.059850    0.054086    0.028030    0.024050    0.021370
				</tableData>
				</table>
			</function>
		</fcs_function>

		<!-- reference for r -->
		<fcs_function name="sas/yaw-v0">
			<function>
				<difference>
					<property>velocities/r-rad_sec</property>
					<property>sas/yaw-rate-predicted-rad_sec</property>
				</difference>
			</function>
		</fcs_function>

		<fcs_function name="sas/yaw-v1">
			<function>
				<product>
					<property>sas/yaw-v0</property>
					<property>sas/yaw-v1-c1</property>
					<table>
						<independentVar lookup="row">velocities/vc-kts</independentVar>
						<tableData>
							100 1.0
							200 0.6
							300 0.3
							400 0.31
							600 0.1
						</tableData>
					</table>
				</product>
			</function>
		</fcs_function>

		<lag_filter name="sas/yaw-v2">
			<input>sas/yaw-v1</input>
			<c1>sas/yaw-v2-c1</c1>
		</lag_filter>

		<washout_filter name="sas/yaw-v3">
			<input>sas/yaw-v2</input>
			<c1>sas/yaw-v3-c1</c1>
		</washout_filter>

		<!-- Feedback loop from output -->
		<lag_filter name="sas/yaw-v7-value">
			<input>sas/yaw-v6</input>
			<c1>sas/yaw-v7-c1</c1>
		</lag_filter>

		<fcs_function name="sas/yaw-v6">
			<function>
				<product>
					<property>sas/yaw-v5</property>
					<property>sas/yaw-v6-c</property>
				</product>
			</function>
		</fcs_function>

		<!-- uses yaw-v-active as initial condition -->
		<fcs_function name="sas/yaw-v7">
			<function>
				<ifthen>
					<or>
						<eq>
							<property>sas/yaw-v-active</property>
							<v>0</v>
						</eq>
						<lt>
							<property>sim-time-sec</property>
							<v>0.5</v>
						</lt>
					</or>
					<property>sas/yaw-v3</property>
					<property>sas/yaw-v7-value</property>
				</ifthen>
			</function>
		</fcs_function>
		<!-- End feedback from output -->

		<fcs_function name="sas/yaw-v5">
			<function>
				<product>
					<difference>
						<property>sas/yaw-v3</property>
						<property>sas/yaw-v7</property>
					</difference>
					<property>sas/yaw-v5-c</property>
				</product>
			</function>
			<clipto>
				<min>-4</min>
				<max>4</max>
			</clipto>
		</fcs_function>

		<!-- active flag - needed for initial reset -->
		<fcs_function name="sas/yaw-v-active">
			<function>
				<ifthen>
					<eq>
						<property>sas/yaw-switch</property>
						<v>0</v>
					</eq>
					<value>0</value>
					<value>1</value>
				</ifthen>
			</function>
			<output>sas/yaw-active</output>
		</fcs_function>

		<fcs_function name="sas/yaw-output">
			<function>
				<ifthen>
					<eq>
						<property>sas/yaw-switch</property>
						<v>0</v>
					</eq>
					<value>0</value>
					<property>-sas/yaw-v7</property>
					>
				</ifthen>
			</function>
			<clipto>
				<min>-4</min>
				<max>4</max>
			</clipto>
		</fcs_function>

	</channel>

	<!-- 
		Roll stability is a roll damper.
		Maximum spoiler is 45deg;  gives pitch up of 1deg nose up
	-->
	<channel name="autoslats">
		<switch name="sas/autoslat-active">
			<default value="0" />
			<test logic="AND" value="1">
			aero/alpha-deg gt 4
			velocities/vc-kts lt 580
			/controls/flight/flaps eq 0
		</test>
		</switch>

		<fcs_function name="sas/autoslat-deg">
			<function>
				<product>
					<property>sas/autoslat-active</property>
					<table>
						<independentVar lookup="row">aero/alpha-deg</independentVar>
						<tableData>
					 4   0
					 7   0.391
				</tableData>
					</table>
				</product>
			</function>
		</fcs_function>

	</channel>
</system>
